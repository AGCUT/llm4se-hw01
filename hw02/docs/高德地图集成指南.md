# 高德地图集成指南

## 一、获取高德地?API Key

### 1. 注册高德开放平台账?

1. 访问 [高德开放平台](https://lbs.amap.com/)
2. 注册/登录账号
3. 进入 [控制台](https://console.amap.com/)

### 2. 创建应用

1. 在控制台点击 **应用管理** ?**我的应用**
2. 点击 **创建新应?*
3. 填写应用信息?
   - 应用名称：AI旅行规划?
   - 应用类型：Web?JS API)

### 3. 添加 Key

1. 在应用详情页，点?**添加 Key**
2. 填写 Key 信息?
   - Key名称：Web端Key（或任意名称?
   - 服务平台：Web?JS API)
   - 白名单：可以留空（开发环境），或添加你的域名（生产环境）
3. 点击 **提交**
4. 复制生成?**Key**

### 4. 配置安全密钥（重要）

高德地图 JS API 2.0 需要配置安全密钥：

1. 在应用详情页，找?**安全密钥** ?**Security JS Code**
2. 复制 **安全密钥**（Security JS Code?
3. 在代码中配置（见下方?

## 二、配置环境变?

?`frontend/.env.local` 文件中添加：

```bash
# 高德地图 API Key
VITE_AMAP_KEY=你的高德地图Key

# 高德地图安全密钥（可选，但推荐配置）
VITE_AMAP_SECURITY_CODE=你的安全密钥
```

## 三、代码配?

### 1. 更新 amap.config.ts（如果需要安全密钥）

如果高德地图要求配置安全密钥，需要在 `frontend/src/config/amap.config.ts` 中添加：

```typescript
// 配置安全密钥（如果需要）
if (import.meta.env.VITE_AMAP_SECURITY_CODE) {
  window._AMapSecurityConfig = {
    securityJsCode: import.meta.env.VITE_AMAP_SECURITY_CODE
  }
}
```

### 2. ?HTML 中配置（推荐方式?

?`frontend/index.html` ?`frontend/public/index.html` 中添加：

```html
<script>
  window._AMapSecurityConfig = {
    securityJsCode: '你的安全密钥'
  }
</script>
```

## 四、使用地图功?

### 1. 在行程详情页查看地图

地图功能已经集成到行程详情页面（`/trip/:id`）的 **地图视图** 标签中?

### 2. 地图功能说明

- **标记?*：显示行程中所有活动的地点
- **路线**：按天连接同一天的活动地点
- **信息窗口**：点击标记点可查看地点详?
- **自动缩放**：地图会自动调整视野以包含所有标记点

### 3. 活动位置数据格式

为了让地图正确显示，AI 生成的行程计划中的活动需要包含位置信息：

```json
{
  "activities": [
    {
      "name": "活动名称",
      "location": {
        "address": "具体地址",
        "coordinates": {
          "lng": 116.397428,
          "lat": 39.90923
        }
      }
    }
  ]
}
```

## 五、地图服?API

### 1. 地理编码（地址转坐标）

```typescript
import { geocode } from '@/services/mapService'

const coordinates = await geocode('北京市天安门')
// 返回: { lng: 116.397428, lat: 39.90923 } ?null
```

### 2. 逆地理编码（坐标转地址?

```typescript
import { reverseGeocode } from '@/services/mapService'

const address = await reverseGeocode(116.397428, 39.90923)
// 返回: "北京市东城区天安门广? ?null
```

### 3. 路线规划

```typescript
import { planRoute } from '@/services/mapService'

const route = await planRoute(
  { lng: 116.397428, lat: 39.90923 },
  { lng: 116.407526, lat: 39.904030 }
)
```

## 六、使?useMap Hook

```typescript
import { useMap } from '@/hooks/useMap'

const MyComponent = () => {
  const { map, AMap, loading, error, isConfigured } = useMap({
    containerId: 'my-map',
    zoom: 12,
    center: [116.397428, 39.90923],
    onMapReady: (map, AMap) => {
      console.log('地图已就?)
      // 可以在这里添加标记、路线等
    }
  })

  return (
    <div>
      {loading && <div>加载?..</div>}
      {error && <div>错误: {error}</div>}
      {!isConfigured && <div>请配置高德地?API Key</div>}
      <div id="my-map" style={{ width: '100%', height: '600px' }} />
    </div>
  )
}
```

## 七、使?TripMap 组件

```typescript
import TripMap from '@/components/trip/TripMap/TripMap'
import type { Trip } from '@/config/supabase.config'

const MyComponent = ({ trip }: { trip: Trip }) => {
  return <TripMap trip={trip} height="600px" />
}
```

## 八、常见问?

### 1. 地图不显?

- 检?API Key 是否正确配置
- 检查浏览器控制台是否有错误
- 确认网络连接正常
- 检查安全密钥是否配置（如果要求?

### 2. 标记点不显示

- 检查活动数据中是否包含 `location.coordinates`
- 确认坐标格式正确：`{ lng: number, lat: number }`

### 3. 路线不显?

- 确认同一天有多个活动地点
- 检查坐标是否正?

### 4. 安全密钥错误

如果看到 "Security JS Code" 相关错误?
- 检查安全密钥是否正确配?
- 确认?HTML 中配置了 `window._AMapSecurityConfig`

## 九、测试地图功?

1. 配置 API Key 后，重启开发服务器
2. 访问行程详情页面（`/trip/:id`?
3. 切换?**地图视图** 标签
4. 应该能看到地图和标记?

## 十、生产环境配?

### 1. 设置白名?

在高德开放平台控制台中，为你?Key 设置白名单：
- 开发环境：可以留空或添?`localhost`
- 生产环境：添加你的域名，?`https://yourdomain.com`

### 2. 限制 API 调用?

- 在控制台设置每日调用量限?
- 监控 API 使用情况

## 十一、相关文?

- `frontend/src/config/amap.config.ts` - 高德地图配置
- `frontend/src/services/mapService.ts` - 地图服务
- `frontend/src/hooks/useMap.ts` - 地图 Hook
- `frontend/src/components/trip/TripMap/TripMap.tsx` - 地图组件
- `frontend/src/pages/TripDetail/MapView.tsx` - 地图视图页面

## 十二、参考文?

- [高德开放平台](https://lbs.amap.com/)
- [高德地图 JS API 文档](https://lbs.amap.com/api/javascript-api/summary)
- [高德地图 JS API 示例](https://lbs.amap.com/demo/javascript-api/example/map/map-show)


