# Web版AI旅行规划师 技术架构设计文档

## 文档版本
- 版本：v1.0
- 日期：2025-11-07
- 状态：设计阶段

---

## 目录
1. [系统架构概览](#系统架构概览)
2. [技术栈选型](#技术栈选型)
3. [功能模块技术映射](#功能模块技术映射)
4. [项目目录结构](#项目目录结构)
5. [数据库设计](#数据库设计)
6. [API设计](#api设计)
7. [部署架构](#部署架构)
8. [开发工具链](#开发工具链)

---

## 一、系统架构概览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         用户层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 桌面浏览器 │  │ 平板浏览器 │  │ 移动浏览器 │  │ PWA应用  │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTPS
┌────────────────────────▼────────────────────────────────────┐
│                      CDN / Nginx                             │
│                   (静态资源 + 反向代理)                        │
└────────────────────────┬────────────────────────────────────┘
                         │
        ┌────────────────┴────────────────┐
        │                                 │
┌───────▼────────┐              ┌─────────▼─────────┐
│   前端应用       │              │    后端服务        │
│  (React/Vue)   │◄────API─────►│  (Node.js/FastAPI)│
│                │              │                   │
│ - 语音输入      │              │ - RESTful API     │
│ - 地图展示      │              │ - WebSocket       │
│ - 行程管理      │              │ - 业务逻辑         │
└────────────────┘              └─────────┬─────────┘
                                          │
                         ┌────────────────┼────────────────┐
                         │                │                │
                ┌────────▼──────┐  ┌──────▼──────┐  ┌─────▼─────┐
                │  数据库服务     │  │  第三方服务  │  │  AI服务   │
                │  (Supabase)   │  │             │  │           │
                │               │  │ - 高德地图   │  │ - 通义千问 │
                │ - PostgreSQL  │  │ - 讯飞语音   │  │ - GPT-4   │
                │ - Redis缓存   │  │ - OSS存储   │  │ - 文心一言 │
                └───────────────┘  └─────────────┘  └───────────┘
```

### 1.2 架构特点
- **前后端分离**：独立开发、部署、扩展
- **微服务友好**：模块化设计，便于后期拆分
- **云原生**：容器化部署，支持弹性伸缩
- **高可用**：数据库主从、Redis缓存、CDN加速

---

## 二、技术栈选型

### 2.1 前端技术栈

#### 核心框架
```json
{
  "框架": "React 18.2.0",
  "理由": "生态完善、性能优秀、社区活跃",
  "备选方案": "Vue 3.3 + Vite"
}
```

#### 完整技术栈清单

| 类别 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **UI框架** | React | 18.2+ | 组件化开发 |
| **构建工具** | Vite | 5.0+ | 快速构建、HMR |
| **路由** | React Router | 6.20+ | 页面路由管理 |
| **状态管理** | Zustand | 4.4+ | 轻量级状态管理 |
| **数据请求** | TanStack Query | 5.0+ | 数据获取、缓存 |
| **UI组件库** | Ant Design | 5.12+ | 基础组件 |
| **样式方案** | Tailwind CSS | 3.4+ | 原子化CSS |
| **地图SDK** | 高德地图 JS API | 2.0 | 地图展示、导航 |
| **语音识别** | Web Speech API / 讯飞WebSocket | - | 语音转文字 |
| **图表库** | ECharts | 5.4+ | 数据可视化 |
| **表单管理** | React Hook Form | 7.49+ | 表单验证 |
| **日期处理** | Day.js | 1.11+ | 日期格式化 |
| **HTTP客户端** | Axios | 1.6+ | API请求 |
| **实时通信** | Socket.io-client | 4.6+ | WebSocket连接 |
| **动画库** | Framer Motion | 10.16+ | 流畅动画 |
| **国际化** | i18next | 23.7+ | 多语言支持 |
| **TypeScript** | TypeScript | 5.3+ | 类型安全 |

#### 开发工具
```json
{
  "代码规范": {
    "ESLint": "8.56.0",
    "Prettier": "3.1.1",
    "lint-staged": "15.2.0"
  },
  "测试工具": {
    "Vitest": "1.1.0",
    "Testing Library": "14.1.2",
    "Playwright": "1.40.0"
  },
  "类型检查": {
    "TypeScript": "5.3.3"
  }
}
```

### 2.2 后端技术栈

#### 核心框架选择

**方案A：Node.js + Express（推荐）**
```json
{
  "runtime": "Node.js 20 LTS",
  "framework": "Express 4.18",
  "language": "TypeScript 5.3",
  "优势": "与前端技术栈统一、生态丰富、开发效率高"
}
```

**方案B：Python + FastAPI**
```json
{
  "runtime": "Python 3.11",
  "framework": "FastAPI 0.109",
  "优势": "异步高性能、自动生成API文档、AI集成方便"
}
```

#### 完整技术栈清单（以Node.js方案为例）

| 类别 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **运行时** | Node.js | 20 LTS | JavaScript运行环境 |
| **Web框架** | Express | 4.18+ | HTTP服务器 |
| **语言** | TypeScript | 5.3+ | 类型安全 |
| **ORM** | Prisma | 5.8+ | 数据库操作 |
| **认证** | Passport.js | 0.7+ | 用户认证 |
| **JWT** | jsonwebtoken | 9.0+ | Token生成验证 |
| **加密** | bcrypt | 5.1+ | 密码加密 |
| **验证** | Joi / Zod | 17.11+ / 3.22+ | 参数验证 |
| **日志** | Winston | 3.11+ | 日志记录 |
| **定时任务** | node-cron | 3.0+ | 定时任务调度 |
| **邮件** | Nodemailer | 6.9+ | 发送邮件 |
| **WebSocket** | Socket.io | 4.6+ | 实时通信 |
| **缓存** | ioredis | 5.3+ | Redis客户端 |
| **文件上传** | Multer | 1.4+ | 文件处理 |
| **API文档** | Swagger | 5.0+ | API文档生成 |
| **限流** | express-rate-limit | 7.1+ | API限流 |
| **安全** | helmet | 7.1+ | 安全头设置 |
| **CORS** | cors | 2.8+ | 跨域处理 |

### 2.3 数据库与存储

| 类别 | 技术选型 | 用途 |
|------|---------|------|
| **主数据库** | PostgreSQL 15 | 用户数据、行程数据、费用记录 |
| **缓存层** | Redis 7.2 | Session、热点数据缓存 |
| **对象存储** | 阿里云OSS / AWS S3 | 用户头像、行程图片 |
| **数据库服务** | Supabase | 提供PostgreSQL + Auth + Storage |

### 2.4 第三方服务集成

| 服务类别 | 选型方案 | SDK/API | 用途 |
|---------|---------|---------|------|
| **AI大模型** | 阿里云通义千问 | HTTP API | 行程生成、智能问答 |
| 备选 | OpenAI GPT-4 | openai SDK | 国际用户 |
| 备选 | DeepSeek | HTTP API | 成本优化 |
| **地图服务** | 高德地图 | JavaScript API 2.0 | 地图展示、路线规划 |
| 备选 | 百度地图 | JavaScript API 3.0 | 备用方案 |
| **语音识别** | 科大讯飞 | WebSocket API | 实时语音识别 |
| 备选 | 阿里云语音 | HTTP API | 语音转文字 |
| 备选 | Web Speech API | 浏览器原生 | 免费但功能有限 |
| **短信服务** | 阿里云SMS | HTTP API | 验证码发送 |
| **邮件服务** | SendGrid / 阿里邮件推送 | SMTP/API | 邮件通知 |

### 2.5 DevOps工具链

| 类别 | 工具 | 用途 |
|------|------|------|
| **版本控制** | Git + GitHub | 代码管理 |
| **容器化** | Docker 24+ | 应用容器化 |
| **容器编排** | Docker Compose | 本地开发环境 |
| **CI/CD** | GitHub Actions | 自动化构建部署 |
| **镜像仓库** | 阿里云容器镜像服务 | 镜像存储 |
| **监控** | Prometheus + Grafana | 性能监控 |
| **日志** | ELK Stack (可选) | 日志分析 |
| **文档** | VitePress / Docusaurus | 项目文档 |

---

## 三、功能模块技术映射

### 3.1 智能行程规划模块

#### 3.1.1 多模态输入功能

**技术栈**：
```javascript
{
  "语音输入": {
    "前端": [
      "Web Speech API (浏览器原生)",
      "科大讯飞 WebSocket SDK",
      "React自定义Hook: useVoiceRecognition"
    ],
    "后端": [
      "讯飞语音识别API",
      "WebSocket服务 (Socket.io)"
    ],
    "流程": "麦克风 → MediaRecorder → WebSocket → 讯飞API → 文字结果"
  },
  "文本输入": {
    "前端": [
      "React Hook Form (表单管理)",
      "Ant Design Input组件",
      "Zod (数据验证)"
    ]
  }
}
```

**核心代码示例**：
```typescript
// hooks/useVoiceRecognition.ts
import { useState, useCallback } from 'react'
import { io } from 'socket.io-client'

export const useVoiceRecognition = () => {
  const [isRecording, setIsRecording] = useState(false)
  const [transcript, setTranscript] = useState('')
  
  const startRecording = useCallback(() => {
    // 方案1: Web Speech API
    const recognition = new webkitSpeechRecognition()
    recognition.lang = 'zh-CN'
    recognition.continuous = true
    recognition.interimResults = true
    
    recognition.onresult = (event) => {
      const text = event.results[event.results.length - 1][0].transcript
      setTranscript(text)
    }
    
    recognition.start()
    setIsRecording(true)
  }, [])
  
  return { isRecording, transcript, startRecording }
}
```

#### 3.1.2 AI行程生成功能

**技术栈**：
```javascript
{
  "前端": {
    "UI": ["React组件", "Ant Design Modal/Steps"],
    "状态管理": "Zustand (tripStore)",
    "API调用": "TanStack Query + Axios",
    "加载动画": "Framer Motion"
  },
  "后端": {
    "API路由": "Express Router",
    "业务逻辑": "TripService类",
    "AI集成": "阿里云DashScope SDK",
    "Prompt管理": "提示词模板引擎",
    "结果解析": "JSON Schema验证"
  },
  "AI服务": {
    "模型": "通义千问 qwen-max",
    "调用方式": "HTTP POST",
    "返回格式": "JSON",
    "错误处理": "重试机制（最多3次）"
  }
}
```

**架构流程**：
```
用户输入 → 前端验证 → API请求 
  ↓
后端接收 → 构建Prompt → 调用LLM API
  ↓
LLM响应 → 解析JSON → 数据验证 → 保存数据库
  ↓
返回前端 → 状态更新 → UI渲染
```

**核心代码示例**：
```typescript
// backend/services/TripService.ts
import axios from 'axios'

export class TripService {
  async generateItinerary(input: TripInput): Promise<TripItinerary> {
    // 1. 构建Prompt
    const prompt = this.buildPrompt(input)
    
    // 2. 调用AI API
    const response = await axios.post(
      'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
      {
        model: 'qwen-max',
        input: { messages: [{ role: 'user', content: prompt }] },
        parameters: {
          result_format: 'message',
          temperature: 0.7,
          max_tokens: 4000
        }
      },
      {
        headers: {
          'Authorization': `Bearer ${process.env.DASHSCOPE_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    )
    
    // 3. 解析结果
    const itinerary = JSON.parse(
      response.data.output.choices[0].message.content
    )
    
    // 4. 数据验证
    const validated = ItinerarySchema.parse(itinerary)
    
    // 5. 保存数据库
    return await this.saveToDatabase(validated)
  }
  
  private buildPrompt(input: TripInput): string {
    return `你是专业的旅行规划师，请根据以下需求生成行程：
目的地：${input.destination}
天数：${input.days}
预算：${input.budget}元
...`
  }
}
```

#### 3.1.3 地图可视化功能

**技术栈**：
```javascript
{
  "前端": {
    "地图库": "高德地图 JavaScript API 2.0",
    "React封装": "@amap/amap-react (或自定义封装)",
    "地图组件": [
      "AMap.Map (地图容器)",
      "AMap.Marker (标记点)",
      "AMap.Polyline (路线)",
      "AMap.InfoWindow (信息窗口)",
      "AMap.Driving (驾车路线规划)"
    ],
    "地图插件": [
      "AMap.ToolBar (缩放工具)",
      "AMap.Scale (比例尺)",
      "AMap.Geolocation (定位)"
    ]
  },
  "数据处理": {
    "地理编码": "高德 Geocoding API",
    "路线规划": "高德 Direction API",
    "坐标转换": "WGS84 ↔ GCJ02"
  }
}
```

**核心代码示例**：
```typescript
// components/TripMap.tsx
import React, { useEffect, useRef } from 'react'
import AMapLoader from '@amap/amap-jsapi-loader'

interface TripMapProps {
  itinerary: Itinerary
  onMarkerClick: (place: Place) => void
}

export const TripMap: React.FC<TripMapProps> = ({ itinerary, onMarkerClick }) => {
  const mapRef = useRef<any>(null)
  const markersRef = useRef<any[]>([])
  
  useEffect(() => {
    AMapLoader.load({
      key: process.env.REACT_APP_AMAP_KEY,
      version: '2.0',
      plugins: ['AMap.Marker', 'AMap.Polyline', 'AMap.Driving']
    }).then(AMap => {
      // 初始化地图
      const map = new AMap.Map('map-container', {
        zoom: 12,
        center: itinerary.center
      })
      mapRef.current = map
      
      // 添加标记点
      itinerary.dailyPlans.forEach((day, dayIndex) => {
        day.activities.forEach((activity, actIndex) => {
          if (activity.location) {
            const marker = new AMap.Marker({
              position: [activity.location.lng, activity.location.lat],
              title: activity.name,
              icon: getIconByType(activity.type),
              label: {
                content: `${dayIndex + 1}-${actIndex + 1}`,
                offset: [0, -30]
              }
            })
            
            marker.on('click', () => onMarkerClick(activity))
            map.add(marker)
            markersRef.current.push(marker)
          }
        })
      })
      
      // 绘制路线
      drawRoutes(map, AMap, itinerary)
    })
    
    return () => {
      mapRef.current?.destroy()
    }
  }, [itinerary])
  
  return <div id="map-container" style={{ width: '100%', height: '600px' }} />
}
```

#### 3.1.4 行程编辑功能

**技术栈**：
```javascript
{
  "前端": {
    "拖拽排序": "dnd-kit (React DnD库)",
    "表单编辑": "React Hook Form",
    "即时保存": "TanStack Query mutation + 防抖",
    "版本对比": "diff库 (可视化差异)"
  },
  "后端": {
    "增量更新": "PATCH请求处理",
    "版本控制": "保存历史版本到JSON字段",
    "并发控制": "乐观锁（版本号）"
  }
}
```

### 3.2 费用预算与管理模块

#### 3.2.1 AI预算分析功能

**技术栈**：
```javascript
{
  "前端": {
    "图表展示": "Apache ECharts",
    "图表类型": ["饼图", "柱状图", "折线图"],
    "数据处理": "lodash (分组、汇总)"
  },
  "后端": {
    "预算计算": "业务逻辑层",
    "AI分析": "LLM生成预算建议",
    "数据聚合": "SQL聚合查询"
  }
}
```

**核心代码示例**：
```typescript
// components/BudgetChart.tsx
import ReactECharts from 'echarts-for-react'

export const BudgetChart = ({ budgetData }) => {
  const option = {
    title: { text: '预算分布' },
    tooltip: { trigger: 'item' },
    series: [{
      type: 'pie',
      radius: '50%',
      data: [
        { value: budgetData.transportation, name: '交通' },
        { value: budgetData.accommodation, name: '住宿' },
        { value: budgetData.food, name: '餐饮' },
        { value: budgetData.tickets, name: '门票' },
        { value: budgetData.shopping, name: '购物' }
      ]
    }]
  }
  
  return <ReactECharts option={option} style={{ height: 400 }} />
}
```

#### 3.2.2 费用记录功能

**技术栈**：
```javascript
{
  "语音记账": {
    "识别": "科大讯飞语音识别",
    "NLP提取": "LLM提取金额和类别",
    "正则匹配": "提取数字和关键词"
  },
  "手动记账": {
    "表单": "React Hook Form",
    "图片上传": "Multer (后端) + OSS (存储)",
    "OCR识别": "阿里云OCR API (可选)"
  },
  "数据存储": {
    "数据库": "expenses表",
    "实时同步": "WebSocket推送"
  }
}
```

### 3.3 用户管理与数据存储模块

#### 3.3.1 注册登录系统

**技术栈**：
```javascript
{
  "认证方案": "JWT + Refresh Token",
  "前端": {
    "表单": "React Hook Form + Zod验证",
    "状态管理": "Zustand authStore",
    "Token存储": "localStorage + httpOnly Cookie",
    "路由守卫": "React Router Loader"
  },
  "后端": {
    "认证框架": "Passport.js",
    "策略": [
      "passport-local (账号密码)",
      "passport-jwt (Token验证)",
      "passport-google-oauth20 (Google登录)",
      "passport-github2 (GitHub登录)"
    ],
    "密码加密": "bcrypt (成本因子12)",
    "Token生成": "jsonwebtoken",
    "Token配置": {
      "accessToken": "15分钟",
      "refreshToken": "7天"
    }
  },
  "安全措施": {
    "限流": "express-rate-limit (5次/15分钟)",
    "CSRF防护": "csurf中间件",
    "XSS防护": "helmet + DOMPurify",
    "SQL注入": "Prisma参数化查询"
  }
}
```

**核心代码示例**：
```typescript
// backend/middleware/auth.ts
import jwt from 'jsonwebtoken'
import { Request, Response, NextFunction } from 'express'

export const authenticate = (req: Request, res: Response, next: NextFunction) => {
  const token = req.headers.authorization?.split(' ')[1]
  
  if (!token) {
    return res.status(401).json({ error: '未提供认证令牌' })
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!)
    req.user = decoded
    next()
  } catch (error) {
    if (error.name === 'TokenExpiredError') {
      return res.status(401).json({ error: '令牌已过期' })
    }
    return res.status(403).json({ error: '无效的令牌' })
  }
}
```

#### 3.3.2 云端数据同步

**技术栈**：
```javascript
{
  "数据库": "Supabase (PostgreSQL + 实时订阅)",
  "实时同步": {
    "方案1": "Supabase Realtime (PostgreSQL触发器)",
    "方案2": "Socket.io (自定义实现)",
    "冲突解决": "Last-Write-Wins + 版本号"
  },
  "离线支持": {
    "前端": "IndexedDB (Dexie.js)",
    "同步策略": "上线后自动同步",
    "冲突检测": "版本时间戳对比"
  }
}
```

---

## 四、项目目录结构

### 4.1 前端项目结构

```
frontend/
├── public/                          # 静态资源
│   ├── favicon.ico
│   ├── index.html
│   └── manifest.json                # PWA配置
│
├── src/
│   ├── api/                         # API请求封装
│   │   ├── client.ts                # Axios实例配置
│   │   ├── auth.api.ts              # 认证相关API
│   │   ├── trip.api.ts              # 行程相关API
│   │   ├── expense.api.ts           # 费用相关API
│   │   └── types.ts                 # API类型定义
│   │
│   ├── assets/                      # 资源文件
│   │   ├── images/
│   │   ├── icons/
│   │   └── styles/
│   │       ├── global.css
│   │       └── variables.css
│   │
│   ├── components/                  # 公共组件
│   │   ├── common/                  # 通用组件
│   │   │   ├── Button/
│   │   │   │   ├── Button.tsx
│   │   │   │   ├── Button.module.css
│   │   │   │   └── index.ts
│   │   │   ├── Modal/
│   │   │   ├── Loading/
│   │   │   └── ErrorBoundary/
│   │   │
│   │   ├── layout/                  # 布局组件
│   │   │   ├── Header/
│   │   │   ├── Sidebar/
│   │   │   ├── Footer/
│   │   │   └── MainLayout/
│   │   │
│   │   ├── trip/                    # 行程相关组件
│   │   │   ├── TripCard/
│   │   │   ├── TripList/
│   │   │   ├── TripMap/
│   │   │   ├── DayPlan/
│   │   │   ├── ActivityItem/
│   │   │   └── ActivityEditor/
│   │   │
│   │   ├── expense/                 # 费用相关组件
│   │   │   ├── BudgetChart/
│   │   │   ├── ExpenseList/
│   │   │   ├── ExpenseForm/
│   │   │   └── VoiceRecorder/
│   │   │
│   │   └── voice/                   # 语音相关组件
│   │       ├── VoiceInput/
│   │       └── VoiceButton/
│   │
│   ├── pages/                       # 页面组件
│   │   ├── Home/
│   │   │   ├── Home.tsx
│   │   │   └── Home.module.css
│   │   ├── Auth/
│   │   │   ├── Login.tsx
│   │   │   └── Register.tsx
│   │   ├── Dashboard/
│   │   │   └── Dashboard.tsx
│   │   ├── TripCreate/
│   │   │   ├── TripCreate.tsx
│   │   │   ├── Steps/
│   │   │   │   ├── InputStep.tsx
│   │   │   │   ├── GenerateStep.tsx
│   │   │   │   └── ReviewStep.tsx
│   │   │   └── index.ts
│   │   ├── TripDetail/
│   │   │   ├── TripDetail.tsx
│   │   │   ├── Timeline.tsx
│   │   │   └── MapView.tsx
│   │   ├── ExpenseManage/
│   │   │   └── ExpenseManage.tsx
│   │   ├── Profile/
│   │   │   ├── Profile.tsx
│   │   │   └── Settings.tsx
│   │   └── NotFound/
│   │       └── NotFound.tsx
│   │
│   ├── hooks/                       # 自定义Hooks
│   │   ├── useAuth.ts               # 认证Hook
│   │   ├── useVoiceRecognition.ts   # 语音识别Hook
│   │   ├── useMap.ts                # 地图Hook
│   │   ├── useTrips.ts              # 行程数据Hook
│   │   ├── useExpenses.ts           # 费用数据Hook
│   │   └── useDebounce.ts           # 防抖Hook
│   │
│   ├── store/                       # 状态管理
│   │   ├── authStore.ts             # 认证状态
│   │   ├── tripStore.ts             # 行程状态
│   │   ├── expenseStore.ts          # 费用状态
│   │   └── uiStore.ts               # UI状态
│   │
│   ├── services/                    # 业务逻辑服务
│   │   ├── voiceService.ts          # 语音服务
│   │   ├── mapService.ts            # 地图服务
│   │   ├── storageService.ts        # 本地存储服务
│   │   └── socketService.ts         # WebSocket服务
│   │
│   ├── utils/                       # 工具函数
│   │   ├── request.ts               # 请求封装
│   │   ├── format.ts                # 格式化工具
│   │   ├── validator.ts             # 验证工具
│   │   ├── constants.ts             # 常量定义
│   │   └── helpers.ts               # 辅助函数
│   │
│   ├── types/                       # TypeScript类型定义
│   │   ├── trip.types.ts
│   │   ├── expense.types.ts
│   │   ├── user.types.ts
│   │   └── api.types.ts
│   │
│   ├── config/                      # 配置文件
│   │   ├── amap.config.ts           # 地图配置
│   │   ├── voice.config.ts          # 语音配置
│   │   └── app.config.ts            # 应用配置
│   │
│   ├── App.tsx                      # 根组件
│   ├── main.tsx                     # 入口文件
│   ├── router.tsx                   # 路由配置
│   └── vite-env.d.ts                # Vite类型声明
│
├── tests/                           # 测试文件
│   ├── unit/
│   ├── integration/
│   └── e2e/
│
├── .env.example                     # 环境变量示例
├── .env.local                       # 本地环境变量（不提交）
├── .eslintrc.json                   # ESLint配置
├── .prettierrc                      # Prettier配置
├── .gitignore
├── Dockerfile                       # Docker配置
├── nginx.conf                       # Nginx配置
├── package.json
├── tsconfig.json                    # TypeScript配置
├── vite.config.ts                   # Vite配置
└── README.md
```

### 4.2 后端项目结构

```
backend/
├── src/
│   ├── controllers/                 # 控制器层
│   │   ├── auth.controller.ts       # 认证控制器
│   │   ├── user.controller.ts       # 用户控制器
│   │   ├── trip.controller.ts       # 行程控制器
│   │   ├── expense.controller.ts    # 费用控制器
│   │   └── voice.controller.ts      # 语音控制器
│   │
│   ├── services/                    # 业务逻辑层
│   │   ├── auth.service.ts
│   │   ├── user.service.ts
│   │   ├── trip.service.ts          # 行程生成逻辑
│   │   ├── expense.service.ts
│   │   ├── ai.service.ts            # AI集成服务
│   │   ├── map.service.ts           # 地图服务
│   │   ├── voice.service.ts         # 语音识别服务
│   │   ├── email.service.ts         # 邮件服务
│   │   └── storage.service.ts       # 对象存储服务
│   │
│   ├── models/                      # 数据模型
│   │   ├── User.model.ts
│   │   ├── Trip.model.ts
│   │   ├── Expense.model.ts
│   │   └── index.ts
│   │
│   ├── routes/                      # 路由定义
│   │   ├── auth.routes.ts
│   │   ├── user.routes.ts
│   │   ├── trip.routes.ts
│   │   ├── expense.routes.ts
│   │   ├── voice.routes.ts
│   │   └── index.ts
│   │
│   ├── middleware/                  # 中间件
│   │   ├── auth.middleware.ts       # 认证中间件
│   │   ├── validate.middleware.ts   # 验证中间件
│   │   ├── error.middleware.ts      # 错误处理中间件
│   │   ├── logger.middleware.ts     # 日志中间件
│   │   ├── rateLimit.middleware.ts  # 限流中间件
│   │   └── upload.middleware.ts     # 文件上传中间件
│   │
│   ├── validators/                  # 数据验证
│   │   ├── auth.validator.ts
│   │   ├── trip.validator.ts
│   │   └── expense.validator.ts
│   │
│   ├── utils/                       # 工具函数
│   │   ├── jwt.util.ts              # JWT工具
│   │   ├── encryption.util.ts       # 加密工具
│   │   ├── logger.util.ts           # 日志工具
│   │   ├── response.util.ts         # 响应格式化
│   │   └── constants.ts             # 常量
│   │
│   ├── config/                      # 配置文件
│   │   ├── database.config.ts       # 数据库配置
│   │   ├── redis.config.ts          # Redis配置
│   │   ├── jwt.config.ts            # JWT配置
│   │   ├── ai.config.ts             # AI服务配置
│   │   ├── map.config.ts            # 地图服务配置
│   │   └── app.config.ts            # 应用配置
│   │
│   ├── types/                       # TypeScript类型
│   │   ├── express.d.ts             # Express类型扩展
│   │   ├── api.types.ts
│   │   └── service.types.ts
│   │
│   ├── prompts/                     # AI提示词模板
│   │   ├── itinerary.prompt.ts      # 行程生成提示词
│   │   ├── budget.prompt.ts         # 预算分析提示词
│   │   └── qa.prompt.ts             # 问答提示词
│   │
│   ├── websocket/                   # WebSocket处理
│   │   ├── socketServer.ts          # Socket服务器
│   │   ├── handlers/
│   │   │   ├── trip.handler.ts
│   │   │   └── voice.handler.ts
│   │   └── middleware/
│   │       └── socketAuth.ts
│   │
│   ├── database/                    # 数据库相关
│   │   ├── prisma/
│   │   │   ├── schema.prisma        # Prisma Schema
│   │   │   ├── migrations/          # 迁移文件
│   │   │   └── seed.ts              # 种子数据
│   │   └── redis/
│   │       └── client.ts            # Redis客户端
│   │
│   ├── jobs/                        # 定时任务
│   │   ├── cleanupExpired.job.ts    # 清理过期数据
│   │   └── index.ts
│   │
│   ├── app.ts                       # Express应用配置
│   └── server.ts                    # 服务器入口
│
├── tests/                           # 测试文件
│   ├── unit/
│   │   ├── services/
│   │   └── utils/
│   ├── integration/
│   │   └── api/
│   └── fixtures/                    # 测试数据
│
├── docs/                            # 文档
│   ├── api/
│   │   └── swagger.yaml             # API文档
│   └── development.md
│
├── scripts/                         # 脚本
│   ├── seed.ts                      # 数据填充
│   └── migrate.ts                   # 数据迁移
│
├── .env.example                     # 环境变量示例
├── .env.development                 # 开发环境变量
├── .env.production                  # 生产环境变量（不提交）
├── .eslintrc.json
├── .prettierrc
├── .gitignore
├── Dockerfile
├── docker-compose.yml
├── package.json
├── tsconfig.json
└── README.md
```

### 4.3 完整项目结构（Monorepo）

```
ai-travel-planner/
├── frontend/                        # 前端应用（见4.1）
├── backend/                         # 后端应用（见4.2）
│
├── shared/                          # 共享代码（可选）
│   ├── types/                       # 共享类型定义
│   │   ├── trip.types.ts
│   │   └── expense.types.ts
│   └── utils/                       # 共享工具函数
│
├── docs/                            # 项目文档
│   ├── 产品功能文档.md
│   ├── 技术架构设计文档.md
│   ├── API文档.md
│   ├── 部署指南.md
│   └── 开发指南.md
│
├── .github/                         # GitHub配置
│   ├── workflows/
│   │   ├── frontend-ci.yml          # 前端CI
│   │   ├── backend-ci.yml           # 后端CI
│   │   └── deploy.yml               # 部署流程
│   └── ISSUE_TEMPLATE/
│
├── docker/                          # Docker配置
│   ├── frontend.Dockerfile
│   ├── backend.Dockerfile
│   └── nginx.conf
│
├── scripts/                         # 项目脚本
│   ├── setup.sh                     # 环境搭建脚本
│   ├── deploy.sh                    # 部署脚本
│   └── backup.sh                    # 备份脚本
│
├── .gitignore
├── .env.example
├── docker-compose.yml               # 完整服务编排
├── package.json                     # 根package.json（monorepo）
├── README.md                        # 项目主文档
└── LICENSE
```

---

## 五、数据库设计

### 5.1 Prisma Schema定义

```prisma
// backend/database/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 用户相关 ====================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  username      String?   @unique
  passwordHash  String?   // 第三方登录可为空
  avatar        String?
  phone         String?   @unique
  
  // 认证相关
  emailVerified Boolean   @default(false)
  phoneVerified Boolean   @default(false)
  
  // 个人偏好
  preferences   Json?     // { travelStyle, budget, interests }
  
  // OAuth
  googleId      String?   @unique
  githubId      String?   @unique
  wechatId      String?   @unique
  
  // 时间戳
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // 关系
  trips         Trip[]
  refreshTokens RefreshToken[]
  
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@map("refresh_tokens")
}

// ==================== 行程相关 ====================

model Trip {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 基本信息
  title         String
  destination   String
  startDate     DateTime
  endDate       DateTime
  days          Int
  
  // 旅行参数
  budget        Decimal  @db.Decimal(10, 2)
  travelers     Int      @default(1)
  travelerTypes Json?    // ["成人", "儿童", "老人"]
  preferences   Json?    // ["美食", "文化", "自然"]
  
  // 行程内容
  overview      Json?    // { summary, highlights, tips }
  dailyPlans    Json     // [{ day, date, theme, activities[] }]
  budgetBreakdown Json?  // { transportation, accommodation, food, ... }
  
  // 地图数据
  mapCenter     Json?    // { lat, lng }
  
  // 状态
  status        TripStatus @default(DRAFT)
  isPublic      Boolean    @default(false)
  shareToken    String?    @unique
  
  // 版本控制
  version       Int        @default(1)
  
  // 时间戳
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  // 关系
  expenses      Expense[]
  
  @@index([userId, createdAt])
  @@map("trips")
}

enum TripStatus {
  DRAFT      // 草稿
  CONFIRMED  // 已确认
  ONGOING    // 进行中
  COMPLETED  // 已完成
  CANCELLED  // 已取消
}

// ==================== 费用相关 ====================

model Expense {
  id          String   @id @default(uuid())
  tripId      String
  trip        Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  
  // 费用信息
  category    ExpenseCategory
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("CNY")
  description String?
  
  // 支付信息
  paymentMethod String?  // 现金/支付宝/微信/信用卡
  payer         String?
  
  // 凭证
  receipt       String?  // OSS链接
  
  // 时间
  expenseDate   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tripId, expenseDate])
  @@map("expenses")
}

enum ExpenseCategory {
  TRANSPORTATION  // 交通
  ACCOMMODATION   // 住宿
  FOOD            // 餐饮
  TICKETS         // 门票
  SHOPPING        // 购物
  ENTERTAINMENT   // 娱乐
  OTHER           // 其他
}
```

### 5.2 Redis缓存设计

```typescript
// backend/database/redis/cacheKeys.ts

export const CACHE_KEYS = {
  // 用户相关
  USER_INFO: (userId: string) => `user:${userId}`,
  USER_SESSION: (sessionId: string) => `session:${sessionId}`,
  
  // 行程相关
  TRIP_DETAIL: (tripId: string) => `trip:${tripId}`,
  USER_TRIPS: (userId: string) => `user:${userId}:trips`,
  
  // API限流
  RATE_LIMIT: (userId: string, endpoint: string) => 
    `ratelimit:${userId}:${endpoint}`,
  
  // AI生成缓存（相同输入返回缓存结果）
  AI_ITINERARY: (hash: string) => `ai:itinerary:${hash}`,
  
  // 地图数据缓存
  GEO_LOCATION: (address: string) => `geo:${address}`,
  
  // 过期时间配置
  TTL: {
    USER_INFO: 3600,        // 1小时
    TRIP_DETAIL: 1800,      // 30分钟
    AI_ITINERARY: 86400,    // 24小时
    GEO_LOCATION: 2592000   // 30天
  }
}
```

---

## 六、API设计

### 6.1 RESTful API规范

**基础URL**：`https://api.ai-travel-planner.com/v1`

**认证方式**：`Authorization: Bearer <access_token>`

**响应格式**：
```typescript
// 成功响应
{
  "success": true,
  "data": { ... },
  "message": "操作成功",
  "timestamp": 1699334400000
}

// 错误响应
{
  "success": false,
  "error": {
    "code": "INVALID_INPUT",
    "message": "输入参数无效",
    "details": { ... }
  },
  "timestamp": 1699334400000
}
```

### 6.2 API端点汇总

#### 认证模块
```
POST   /auth/register              # 邮箱注册
POST   /auth/login                 # 登录
POST   /auth/logout                # 登出
POST   /auth/refresh               # 刷新Token
POST   /auth/forgot-password       # 忘记密码
POST   /auth/reset-password        # 重置密码
GET    /auth/verify-email/:token   # 验证邮箱
POST   /auth/oauth/google          # Google OAuth
POST   /auth/oauth/github          # GitHub OAuth
```

#### 用户模块
```
GET    /users/me                   # 获取当前用户信息
PUT    /users/me                   # 更新用户信息
PUT    /users/me/password          # 修改密码
POST   /users/me/avatar            # 上传头像
GET    /users/me/preferences       # 获取用户偏好
PUT    /users/me/preferences       # 更新用户偏好
```

#### 行程模块
```
GET    /trips                      # 获取行程列表
POST   /trips                      # 创建行程
GET    /trips/:id                  # 获取行程详情
PUT    /trips/:id                  # 更新行程
DELETE /trips/:id                  # 删除行程
PATCH  /trips/:id/status           # 更新行程状态

POST   /trips/generate             # AI生成行程
POST   /trips/:id/duplicate        # 复制行程
POST   /trips/:id/share            # 生成分享链接
GET    /trips/shared/:token        # 访问分享行程
POST   /trips/:id/export           # 导出PDF
```

#### 费用模块
```
GET    /trips/:tripId/expenses     # 获取费用列表
POST   /trips/:tripId/expenses     # 添加费用记录
GET    /expenses/:id               # 获取费用详情
PUT    /expenses/:id               # 更新费用记录
DELETE /expenses/:id               # 删除费用记录

GET    /trips/:tripId/budget-analysis  # 预算分析
POST   /expenses/voice-parse       # 语音解析费用
POST   /expenses/ocr               # OCR识别小票
```

#### 语音模块
```
POST   /voice/recognize            # 语音识别
WS     /voice/stream               # 实时语音流（WebSocket）
```

#### 地图模块
```
POST   /map/geocode                # 地理编码
POST   /map/directions             # 路线规划
GET    /map/places/search          # POI搜索
```

### 6.3 WebSocket事件

```typescript
// 客户端 → 服务器
{
  "voice:start": {},                // 开始语音识别
  "voice:data": { audio: Blob },    // 音频数据流
  "voice:end": {},                  // 结束语音识别
  
  "trip:subscribe": { tripId },     // 订阅行程更新
  "trip:unsubscribe": { tripId },   // 取消订阅
  "trip:edit": { tripId, changes }  // 编辑行程（协作）
}

// 服务器 → 客户端
{
  "voice:result": { text, final },  // 识别结果
  "voice:error": { message },       // 识别错误
  
  "trip:updated": { tripId, data }, // 行程已更新
  "trip:user-join": { userId },     // 用户加入协作
  "trip:user-leave": { userId }     // 用户离开协作
}
```

---

## 七、部署架构

### 7.1 Docker容器架构

```yaml
# docker-compose.yml

version: '3.8'

services:
  # 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ai-travel-frontend
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    restart: unless-stopped
    networks:
      - app-network

  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ai-travel-backend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - AMAP_KEY=${AMAP_KEY}
    depends_on:
      - postgres
      - redis
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - app-network

  # PostgreSQL数据库
  postgres:
    image: postgres:15-alpine
    container_name: ai-travel-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=ai_travel_planner
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/database/init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    networks:
      - app-network

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: ai-travel-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - app-network

  # Nginx（可选，用于负载均衡）
  nginx:
    image: nginx:alpine
    container_name: ai-travel-nginx
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - app-network

volumes:
  postgres_data:
  redis_data:

networks:
  app-network:
    driver: bridge
```

### 7.2 CI/CD流程

```yaml
# .github/workflows/deploy.yml

name: Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: |
          cd frontend && npm ci
          cd ../backend && npm ci
      
      - name: Run Tests
        run: |
          cd frontend && npm test
          cd ../backend && npm test
      
      - name: Lint
        run: |
          cd frontend && npm run lint
          cd ../backend && npm run lint

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v2
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}
      
      - name: Build and Push Frontend
        run: |
          docker build -t registry.cn-hangzhou.aliyuncs.com/your-namespace/ai-travel-frontend:latest ./frontend
          docker push registry.cn-hangzhou.aliyuncs.com/your-namespace/ai-travel-frontend:latest
      
      - name: Build and Push Backend
        run: |
          docker build -t registry.cn-hangzhou.aliyuncs.com/your-namespace/ai-travel-backend:latest ./backend
          docker push registry.cn-hangzhou.aliyuncs.com/your-namespace/ai-travel-backend:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/ai-travel-planner
            docker-compose pull
            docker-compose up -d
            docker system prune -f
```

### 7.3 部署拓扑图

```
                    ┌─────────────┐
                    │   用户设备   │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │   CDN/DNS   │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │         阿里云/AWS/腾讯云             │
        │                                      │
        │  ┌────────────┐    ┌────────────┐  │
        │  │  负载均衡   │    │   Docker    │  │
        │  │  (SLB)    │───▶│   Swarm     │  │
        │  └────────────┘    └──────┬─────┘  │
        │                           │         │
        │  ┌────────┬────────┬──────▼─────┐  │
        │  │Frontend│Backend │  Backend   │  │
        │  │ Node 1 │ Node 1 │  Node 2    │  │
        │  └────┬───┴───┬────┴────┬───────┘  │
        │       │       │         │          │
        │  ┌────▼───────▼─────────▼──────┐  │
        │  │      PostgreSQL集群          │  │
        │  │    (主从 + Supabase)         │  │
        │  └──────────────────────────────┘  │
        │                                     │
        │  ┌──────────────────────────────┐  │
        │  │        Redis集群              │  │
        │  │    (哨兵模式/集群模式)         │  │
        │  └──────────────────────────────┘  │
        │                                     │
        │  ┌──────────────────────────────┐  │
        │  │      对象存储 (OSS)           │  │
        │  └──────────────────────────────┘  │
        └─────────────────────────────────────┘
```

---

## 八、开发工具链

### 8.1 必备工具

| 工具 | 用途 | 版本 |
|------|------|------|
| **Node.js** | JavaScript运行时 | 20 LTS |
| **npm/pnpm** | 包管理器 | 9+ / 8+ |
| **Git** | 版本控制 | 2.40+ |
| **Docker** | 容器化 | 24+ |
| **Docker Compose** | 容器编排 | 2.20+ |
| **VS Code** | 代码编辑器 | 最新版 |
| **Postman** | API测试 | 最新版 |

### 8.2 VS Code推荐插件

```json
{
  "recommendations": [
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "prisma.prisma",
    "ms-vscode.vscode-typescript-next",
    "bradlc.vscode-tailwindcss",
    "christian-kohler.path-intellisense",
    "usernamehw.errorlens",
    "eamodio.gitlens",
    "ms-azuretools.vscode-docker",
    "humao.rest-client"
  ]
}
```

### 8.3 开发脚本

```json
// package.json scripts
{
  "scripts": {
    // 开发
    "dev": "concurrently \"npm run dev:frontend\" \"npm run dev:backend\"",
    "dev:frontend": "cd frontend && npm run dev",
    "dev:backend": "cd backend && npm run dev",
    
    // 构建
    "build": "npm run build:frontend && npm run build:backend",
    "build:frontend": "cd frontend && npm run build",
    "build:backend": "cd backend && npm run build",
    
    // 测试
    "test": "npm run test:frontend && npm run test:backend",
    "test:frontend": "cd frontend && npm test",
    "test:backend": "cd backend && npm test",
    
    // 数据库
    "db:migrate": "cd backend && npx prisma migrate dev",
    "db:seed": "cd backend && npx prisma db seed",
    "db:studio": "cd backend && npx prisma studio",
    
    // Docker
    "docker:build": "docker-compose build",
    "docker:up": "docker-compose up -d",
    "docker:down": "docker-compose down",
    "docker:logs": "docker-compose logs -f",
    
    // 代码质量
    "lint": "npm run lint:frontend && npm run lint:backend",
    "lint:fix": "npm run lint:frontend -- --fix && npm run lint:backend -- --fix",
    "format": "prettier --write \"**/*.{ts,tsx,js,jsx,json,css,md}\"",
    
    // 部署
    "deploy": "sh scripts/deploy.sh"
  }
}
```

---

## 九、开发流程规范

### 9.1 Git工作流

```bash
# 分支策略
main          # 生产环境分支
develop       # 开发环境分支
feature/*     # 功能分支
bugfix/*      # Bug修复分支
hotfix/*      # 紧急修复分支

# Commit规范（Conventional Commits）
feat: 新功能
fix: Bug修复
docs: 文档更新
style: 代码格式
refactor: 重构
test: 测试
chore: 构建/工具

# 示例
git commit -m "feat: 实现语音识别功能"
git commit -m "fix: 修复地图标记显示bug"
```

### 9.2 代码审查清单

- [ ] 代码符合ESLint规范
- [ ] 所有测试通过
- [ ] 添加了必要的注释
- [ ] 更新了相关文档
- [ ] 没有console.log等调试代码
- [ ] 敏感信息没有硬编码
- [ ] API Key正确管理
- [ ] 性能影响评估

---

## 十、性能优化方案

### 10.1 前端优化

| 优化点 | 方案 | 工具/技术 |
|--------|------|----------|
| **代码分割** | 路由懒加载、动态导入 | React.lazy, Suspense |
| **资源优化** | 图片压缩、WebP格式 | tinypng, imagemin |
| **缓存策略** | Service Worker、CDN | Workbox |
| **打包优化** | Tree Shaking、压缩 | Vite, Terser |
| **首屏加载** | SSR、预渲染 | Next.js |
| **骨架屏** | 加载占位 | React Content Loader |

### 10.2 后端优化

| 优化点 | 方案 | 工具/技术 |
|--------|------|----------|
| **数据库查询** | 索引优化、连接池 | Prisma, pg-pool |
| **缓存** | Redis多级缓存 | ioredis |
| **API限流** | Token Bucket | express-rate-limit |
| **并发处理** | Worker Threads | Node.js Cluster |
| **日志** | 异步日志 | Winston |

---

## 十一、监控与运维

### 11.1 监控指标

```typescript
// 关键指标
{
  "性能指标": {
    "API响应时间": "< 500ms",
    "页面加载时间": "< 2s",
    "AI生成时间": "< 10s"
  },
  "可用性指标": {
    "系统可用率": "> 99.5%",
    "错误率": "< 0.1%"
  },
  "业务指标": {
    "日活用户": "DAU",
    "行程生成成功率": "> 95%",
    "用户留存率": "D1, D7, D30"
  }
}
```

### 11.2 日志规范

```typescript
// backend/utils/logger.ts
import winston from 'winston'

export const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
})

// 日志分类
logger.info('用户登录', { userId, ip, timestamp })
logger.error('AI生成失败', { error, input, timestamp })
logger.warn('API调用超限', { userId, endpoint, timestamp })
```

---

## 十二、安全方案

### 12.1 安全措施清单

- [x] HTTPS加密传输
- [x] JWT Token认证
- [x] 密码bcrypt加密
- [x] SQL注入防护（Prisma参数化）
- [x] XSS防护（DOMPurify）
- [x] CSRF防护（CSRF Token）
- [x] API限流
- [x] 敏感数据脱敏
- [x] 定期安全审计

### 12.2 环境变量管理

```bash
# .env.example

# === 应用配置 ===
NODE_ENV=development
PORT=3000
CLIENT_URL=http://localhost:5173

# === 数据库 ===
DATABASE_URL=postgresql://user:pass@localhost:5432/ai_travel_planner
REDIS_URL=redis://:password@localhost:6379

# === JWT ===
JWT_SECRET=your-256-bit-secret
JWT_EXPIRES_IN=15m
REFRESH_TOKEN_EXPIRES_IN=7d

# === AI服务 ===
# 阿里云通义千问
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxx
DASHSCOPE_API_URL=https://dashscope.aliyuncs.com

# === 地图服务 ===
AMAP_KEY=your-amap-key
AMAP_SECRET=your-amap-secret

# === 语音识别 ===
XUNFEI_APP_ID=your-app-id
XUNFEI_API_KEY=your-api-key
XUNFEI_API_SECRET=your-api-secret

# === 对象存储 ===
OSS_ACCESS_KEY_ID=your-access-key-id
OSS_ACCESS_KEY_SECRET=your-access-key-secret
OSS_BUCKET=ai-travel-planner
OSS_REGION=oss-cn-hangzhou

# === 邮件服务 ===
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASSWORD=your-password

# === 短信服务 ===
SMS_ACCESS_KEY_ID=your-key
SMS_ACCESS_KEY_SECRET=your-secret
SMS_SIGN_NAME=AI旅行规划师
```

---

## 附录

### A. 技术选型对比表

| 对比项 | React | Vue |
|--------|-------|-----|
| 学习曲线 | 中等 | 较低 |
| 生态系统 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 性能 | 优秀 | 优秀 |
| TypeScript支持 | 优秀 | 良好 |
| 社区活跃度 | 极高 | 高 |
| 推荐度 | ✅ 推荐 | ✅ 推荐 |

| 对比项 | Node.js | Python |
|--------|---------|--------|
| 性能 | 高（异步IO） | 中 |
| 开发效率 | 高 | 极高 |
| AI集成 | 良好 | 优秀 |
| 技术栈统一 | ✅ | ❌ |
| 推荐度 | ✅ 推荐 | ✅ 推荐 |

### B. 第三方服务定价参考

| 服务 | 免费额度 | 付费价格 |
|------|---------|---------|
| **阿里云通义千问** | 无 | ¥0.008/1K tokens |
| **高德地图API** | 10万次/日 | 超出部分计费 |
| **科大讯飞语音** | 5万次/日 | 按调用量计费 |
| **Supabase** | 500MB DB, 1GB存储 | $25/月起 |
| **阿里云OSS** | 无 | ¥0.12/GB/月 |

---

**文档版本**：v1.0  
**最后更新**：2025-11-07  
**维护者**：开发团队


